---
title: "ACS notebook"
author: "Matthew Cvitanovich"
output:
  html_document:
    df_print: paged
    theme: paper
    code_folding: hide
  html_notebook: null
editor_options:
  chunk_output_type: console
---

<style>
  .Notes {
    background-color: #FDF9E4;
    padding: 10px;
    border: 1px solid;
    border-color: #F7EBCF;
    margin-left: 50px;
    margin-right: 50px;
    border-radius: 5px;
    color: #866E42;}
</style>

This is a proof-of-concept notebook exemplifying how one might obtain 
estimates of the following probabilities for an individual based on their age 
(category), sex, and race/ethnicity using data from the 
[American Census Survey (ACS)](https://www.census.gov/programs-surveys/acs).    
  **(1)** highest level of education achieved  
  **(2)** having experienced income below/above the Federal 
poverty level within the preceding 12 months 

```{r message=FALSE}

##################################################################
#                   Configuration
#
#                  !!! WARNING !!!
#
# The following packages will be installed to the users R library:
#   - tidycensus
#   - vroom
#   - dplyr
#   - tidyr
#   - stringr
#   - readr
#   - ggplot2

# If the user prefers not to install directly to their R library,
# they may opt to use either of the following to create a project-
# specific library.
# (1) Renv (e.g., RStudio:: Project options -> Environments)
# (2) Packrat

##################################################################


# install missing packages
# ------------------------
packages.required <- c('tidycensus', 'vroom', 'dplyr', 
                       'tidyr', 'stringr', 'readr', 'ggplot2')

packages.toinstall <- packages.required[!(packages.required %in% installed.packages()[,"Package"])]

if(length(packages.toinstall)) install.packages(packages.toinstall)




library(tidycensus)
library(dplyr)
library(stringr)
library(readr)
library(ggplot2)

census_api_key(Sys.getenv('CENSUS_KEY'))

# load Census concepts
v20 <- load_variables(2020, "acs5", cache = TRUE)
```



```{r include=FALSE, message=FALSE}

##################################################################
#                   Inspect Table IDs
##################################################################

# Educational Attainment
ed_vars <- v20 %>% 
  filter(grepl('SEX BY EDUCATIONAL ATTAINMENT FOR THE POPULATION 25 YEARS AND OVER', concept)) %>% 
  mutate(name_stub = substr(name, 1, 7)) %>% 
  distinct(concept, name_stub)

# Age
age_vars <- v20 %>% 
  filter(grepl('SEX BY AGE BY EDUCATIONAL ATTAINMENT FOR THE POPULATION 18 YEARS AND OVER', concept)) %>% 
  mutate(name_stub = substr(name, 1, 7)) %>% 
  distinct(concept, name_stub)

# Poverty
pov_vars <- v20 %>% 
  filter(grepl('POVERTY', concept)) %>% 
  mutate(name_stub = substr(name, 1, 7)) %>% 
  distinct(concept, name_stub)
```



```{r message=FALSE, warning=FALSE}

##################################################################
#                   Define API Requests
##################################################################


# Pr[educational attainment | sex, race/ethnicity, Census tract]
# ----------------------------------------------------------------
request_ed_by_tract <- function(raceth){
  varlist <- c('C15002A', 'C15002B', 'C15002C', 'C15002D',
               'C15002E', 'C15002F', 'C15002G', 'C15002I')
  
  names(varlist) <- c('white', 'black', 'alaskan', 'asian', 
                      'hawaian', 'other', 'multirace', 'hispanic')
  
  df <- get_acs(geography = "tract", 
                   survey = 'acs5',
                   variables = c(total = paste0(varlist[raceth], "_001"),
                                 # male
                                 male = paste0(varlist[raceth], "_002"),
                                 male_less_hs = paste0(varlist[raceth], "_003"),
                                 male_hs_graduate = paste0(varlist[raceth], "_004"),
                                 male_some_college = paste0(varlist[raceth], "_005"),
                                 male_college_graduate = paste0(varlist[raceth], "_006"),
                                 # female
                                 female = paste0(varlist[raceth], "_007"),
                                 female_less_hs = paste0(varlist[raceth], "_008"),
                                 female_hs_graduate = paste0(varlist[raceth], "_009"),
                                 female_some_college = paste0(varlist[raceth], "_010"),
                                 female_college_graduate = paste0(varlist[raceth], "_011")),
                    state='TX',
                    county='Tarrant',
                    year = 2020,
                    moe_level=95)
  
  return(df)
}



# Pr[educational attainment | age]
# ----------------------------------
request_age_for_us <- function(){
  
  df <- get_acs(
    geography = "us", 
    survey = 'acs5',
    variables = c(# male
      male_25_34_less_9       = paste0('B15001', "_012"),
      male_25_34_less_hs      = paste0('B15001', "_013"),
      male_25_34_hs_graduate  = paste0('B15001', "_014"),
      male_25_34_some_college = paste0('B15001', "_015"),
      male_25_34_associates   = paste0('B15001', "_016"),
      male_25_34_bachelors    = paste0('B15001', "_017"),
      male_25_34_graduate     = paste0('B15001', "_018"),

      male_35_44_less_9       = paste0('B15001', "_020"),
      male_35_44_less_hs      = paste0('B15001', "_021"),
      male_35_44_hs_graduate  = paste0('B15001', "_022"),
      male_35_44_some_college = paste0('B15001', "_023"),
      male_35_44_associates   = paste0('B15001', "_024"),
      male_35_44_bachelors    = paste0('B15001', "_025"),
      male_35_44_graduate     = paste0('B15001', "_026"),
     
      male_45_64_less_9       = paste0('B15001', "_028"),
      male_45_64_less_hs      = paste0('B15001', "_029"),
      male_45_64_hs_graduate  = paste0('B15001', "_030"),
      male_45_64_some_college = paste0('B15001', "_031"),
      male_45_64_associates   = paste0('B15001', "_032"),
      male_45_64_bachelors    = paste0('B15001', "_033"),
      male_45_64_graduate     = paste0('B15001', "_034"),
     
      male_65_pl_less_9       = paste0('B15001', "_036"),
      male_65_pl_less_hs      = paste0('B15001', "_037"),
      male_65_pl_hs_graduate  = paste0('B15001', "_038"),
      male_65_pl_some_college = paste0('B15001', "_039"),
      male_65_pl_associates   = paste0('B15001', "_040"),
      male_65_pl_bachelors    = paste0('B15001', "_041"),
      male_65_pl_graduate     = paste0('B15001', "_042"),
     
      # female
      female_25_34_less_9       = paste0('B15001', "_053"),
      female_25_34_less_hs      = paste0('B15001', "_054"),
      female_25_34_hs_graduate  = paste0('B15001', "_055"),
      female_25_34_some_college = paste0('B15001', "_056"),
      female_25_34_associates   = paste0('B15001', "_057"),
      female_25_34_bachelors    = paste0('B15001', "_058"),
      female_25_34_graduate     = paste0('B15001', "_059"),

      female_35_44_less_9       = paste0('B15001', "_061"),
      female_35_44_less_hs      = paste0('B15001', "_062"),
      female_35_44_hs_graduate  = paste0('B15001', "_063"),
      female_35_44_some_college = paste0('B15001', "_064"),
      female_35_44_associates   = paste0('B15001', "_065"),
      female_35_44_bachelors    = paste0('B15001', "_066"),
      female_35_44_graduate     = paste0('B15001', "_067"),
     
      female_45_64_less_9       = paste0('B15001', "_069"),
      female_45_64_less_hs      = paste0('B15001', "_070"),
      female_45_64_hs_graduate  = paste0('B15001', "_071"),
      female_45_64_some_college = paste0('B15001', "_072"),
      female_45_64_associates   = paste0('B15001', "_073"),
      female_45_64_bachelors    = paste0('B15001', "_074"),
      female_45_64_graduate     = paste0('B15001', "_075"),
     
      female_65_pl_less_9       = paste0('B15001', "_077"),
      female_65_pl_less_hs      = paste0('B15001', "_078"),
      female_65_pl_hs_graduate  = paste0('B15001', "_079"),
      female_65_pl_some_college = paste0('B15001', "_080"),
      female_65_pl_associates   = paste0('B15001', "_081"),
      female_65_pl_bachelors    = paste0('B15001', "_082"),
      female_65_pl_graduate     = paste0('B15001', "_083")
      ),
    year = 2020,
    moe_level=95)
  
  return(df)
}





# Pr[age category | sex, race/ethnicity, Census tract)
# -------------------------------------------------------------
# ... B01001A == "Sex by Age" ... with smaller age categories
request_age_by_tract <- function(raceth){
  varlist <- c('B01001A', 'B01001B', 'B01001C', 'B01001D',
               'B01001E', 'B01001F', 'B01001G', 'B01001I')
  
  names(varlist) <- c('white', 'black', 'alaskan', 'asian', 
                      'hawaian', 'other', 'multirace', 'hispanic')
  
  df <- get_acs(geography = "tract", 
                   survey = 'acs5',
                   variables = c(total      = paste0(varlist[raceth], "_001"),
                                 # male
                                 male       = paste0(varlist[raceth], "_002"),
                                 male_25_29 = paste0(varlist[raceth], "_009"),
                                 male_30_34 = paste0(varlist[raceth], "_010"),
                                 male_35_44 = paste0(varlist[raceth], "_011"),
                                 male_45_54 = paste0(varlist[raceth], "_012"),
                                 male_55_64 = paste0(varlist[raceth], "_013"),
                                 male_65_74 = paste0(varlist[raceth], "_014"),
                                 male_75_84 = paste0(varlist[raceth], "_015"),
                                 male_85_pl = paste0(varlist[raceth], "_016"),
                                 # female
                                 female       = paste0(varlist[raceth], "_017"),
                                 female_25_29 = paste0(varlist[raceth], "_024"),
                                 female_30_34 = paste0(varlist[raceth], "_025"),
                                 female_35_44 = paste0(varlist[raceth], "_026"),
                                 female_45_54 = paste0(varlist[raceth], "_027"),
                                 female_55_64 = paste0(varlist[raceth], "_028"),
                                 female_65_74 = paste0(varlist[raceth], "_029"),
                                 female_75_84 = paste0(varlist[raceth], "_030"),
                                 female_85_pl = paste0(varlist[raceth], "_031")
                                 ),
                    state='TX',
                    county='Tarrant',
                    year = 2020,
                    moe_level=95)
  
  return(df)
}



# Pr[educational attainment | age category, sex, race/ethnicity, Census tract]
# -----------------------------------------------------------------------------
# https://data.census.gov/cedsci/table?q=B17001
request_below_poverty_by_tract <- function(raceth){
  varlist <- c('B17001A', 'B17001B', 'B17001C', 'B17001D',
               'B17001E', 'B17001F', 'B17001G', 'B17001I')
  
  names(varlist) <- c('white', 'black', 'alaskan', 'asian', 
                      'hawaian', 'other', 'multirace', 'hispanic')
  
  below <- get_acs(geography = "tract", 
                   survey = 'acs5',
                   variables = c(total      = paste0(varlist[raceth], "_002"),
                                 # male
                                 male       = paste0(varlist[raceth], "_003"),
                                 male_25_34 = paste0(varlist[raceth], "_011"),
                                 male_35_44 = paste0(varlist[raceth], "_012"),
                                 male_45_54 = paste0(varlist[raceth], "_013"),
                                 male_55_64 = paste0(varlist[raceth], "_014"),
                                 male_65_74 = paste0(varlist[raceth], "_015"),
                                 male_75_pl = paste0(varlist[raceth], "_016"),
                                 # female
                                 female       = paste0(varlist[raceth], "_017"),
                                 female_25_34 = paste0(varlist[raceth], "_025"),
                                 female_35_44 = paste0(varlist[raceth], "_026"),
                                 female_45_54 = paste0(varlist[raceth], "_027"),
                                 female_55_64 = paste0(varlist[raceth], "_028"),
                                 female_65_74 = paste0(varlist[raceth], "_029"),
                                 female_75_pl = paste0(varlist[raceth], "_030")
                                 ),
                   state='TX',
                   county='Tarrant',
                   year = 2020,
                   moe_level=95) %>% 
    mutate(poverty_status = 'Below')
  
  
  above <- get_acs(geography = "tract", 
                   survey = 'acs5',
                   variables = c(total      = paste0(varlist[raceth], "_031"),
                                 # male
                                 male       = paste0(varlist[raceth], "_032"),
                                 male_25_34 = paste0(varlist[raceth], "_040"),
                                 male_35_44 = paste0(varlist[raceth], "_041"),
                                 male_45_54 = paste0(varlist[raceth], "_042"),
                                 male_55_64 = paste0(varlist[raceth], "_043"),
                                 male_65_74 = paste0(varlist[raceth], "_044"),
                                 male_75_pl = paste0(varlist[raceth], "_045"),
                                 # female
                                 female       = paste0(varlist[raceth], "_046"),
                                 female_25_34 = paste0(varlist[raceth], "_054"),
                                 female_35_44 = paste0(varlist[raceth], "_055"),
                                 female_45_54 = paste0(varlist[raceth], "_056"),
                                 female_55_64 = paste0(varlist[raceth], "_057"),
                                 female_65_74 = paste0(varlist[raceth], "_058"),
                                 female_75_pl = paste0(varlist[raceth], "_059")
                                 ),
                   state='TX',
                   county='Tarrant',
                   year = 2020,
                   moe_level=95) %>% 
    mutate(poverty_status = 'Above')
  
  df <- rbind(below, above)
  
  return(df)
}
```


```{r message=FALSE}
##################################################################
#                   Process API Requests
##################################################################


# Race/ethnicity-specific proportions of (education, sex) by tract
# ----------------------------------------------------------------
create_ed_by_tract_df <- function(){
  # Educational Attainment
  white <- request_ed_by_tract('white') %>% mutate(race = 'white')
  black <- request_ed_by_tract('black') %>% mutate(race = 'black')
  alaskan <- request_ed_by_tract('alaskan') %>% mutate(race = 'alaskan')
  asian <- request_ed_by_tract('asian') %>% mutate(race = 'asian')
  hawaian <- request_ed_by_tract('hawaian') %>% mutate(race = 'hawaian')
  other <- request_ed_by_tract('other') %>% mutate(race = 'other')
  multirace <- request_ed_by_tract('multirace') %>% mutate(race = 'multirace')
  hispanic <- request_ed_by_tract('hispanic') %>% mutate(race = 'hispanic')
  
  # combine all requests
  ed <- rbind(white, black, alaskan, asian, hawaian, other, multirace, hispanic)
  
  # extract Census tract from text
  ed <- ed %>% 
    mutate(
      tract = str_extract(NAME, '\\d+\\.*\\d*'),
      tract = case_when(
           str_length(tract) == 4 ~ paste0(tract, '.00'),
           str_length(tract) >4 & str_length(tract) <7 ~ str_pad(tract, 7, side='right', pad='0'),
           str_length(tract) ==7 ~ tract,
           TRUE ~ 'INVESTIGATE'
         ),
      sex = case_when(
        grepl('female', variable) ~ 'Female',
        grepl('male', variable)   ~ 'Male',
        TRUE ~ 'Total'),
      education = case_when(
        grepl('less_hs', variable)   ~ 'Less than high school',
        grepl('hs_graduate', variable)   ~ 'High school graduate',
        grepl('some_college', variable)   ~ 'Some college',
        grepl('college_graduate', variable)   ~ 'College graduate',
        TRUE ~ 'Total')
      )
  
  
  ed <- ed %>% 
    left_join(ed %>%
                # the denominators need to be adjusted to that they only consider
                #   the age categories of interest
                # ... doesn't need to happen here but for consistency with other code
                # ... I've left this part in
                filter(education != 'Total' & sex != 'Total') %>% 
                group_by(tract, sex, race) %>% 
                mutate(denom = sum(estimate, na.remove=TRUE)) %>% 
                distinct(tract, sex, race, denom)
              ) %>% 
    left_join(ed %>% 
                filter(education == 'Total' & sex != 'Total') %>% 
                distinct(tract, sex, race, moe) %>% 
                rename(moe_denom = moe)
              ) %>% 
    mutate(proportion = estimate/denom,
           proportion_moe = abs(sqrt((moe^2) - ((estimate/denom)^2 * moe_denom)))/denom,
           proportion_moe = ifelse(education=='Total', NA_real_, proportion_moe)
           ) %>% 
    # clean up
    rename(geoid=GEOID, name=NAME) %>%
    distinct(education, sex, race, tract, .keep_all=TRUE)
  
  return(ed)
  
}



# National proportions of (education, age) ... marginalized over sex
# ------------------------------------------------------------------
create_age_df <- function(){
  age <- request_age_for_us()
  
  age <- age %>% 
    mutate(
      sex = case_when(
        grepl('female', variable) ~ 'Female',
        grepl('male', variable)   ~ 'Male',
        TRUE ~ 'Total'),
      agecat = case_when(
        grepl('25_34', variable)   ~ '25-34',
        grepl('35_44', variable)   ~ '35-44',
        grepl('45_64', variable)   ~ '45-64',
        grepl('65_pl', variable)   ~ '>=65',
        TRUE ~ 'Total'),
      education = case_when(
        grepl('less_hs|less_9', variable)   ~ 'Less than high school',
        grepl('hs_graduate', variable)   ~ 'High school graduate',
        grepl('some_college', variable)   ~ 'Some college',
        grepl('associates|bachelors|graduate', variable)   ~ 'College graduate',
        TRUE ~ 'Total')
      ) %>% 
    group_by(education, agecat) %>% 
    mutate(estimate = sum(estimate),
           moe = abs(sqrt( sum(moe^2) ))
    ) %>% 
    ungroup(education, agecat) %>%
    select(education, agecat, estimate, moe) %>% 
    distinct() %>% 
    group_by(agecat) %>% 
    mutate(denom = sum(estimate),
           moe_denom = abs(sqrt( sum(moe^2) ))
           ) %>% 
    ungroup() %>% 
    mutate(proportion = estimate/denom,
           proportion_moe = abs(sqrt((moe^2) - ((estimate/denom)^2 * moe_denom)))/denom
    ) %>%
    distinct(education, agecat, .keep_all=TRUE)
  
  return(age)
  
}



# Race/ethnicity-specific proportions of poverty status by by (tract, sex, age)
# -----------------------------------------------------------------------------
create_poverty_by_tract_df <- function(){
  # Educational Attainment
  white <- request_below_poverty_by_tract('white') %>% mutate(race = 'white')
  black <- request_below_poverty_by_tract('black') %>% mutate(race = 'black')
  alaskan <- request_below_poverty_by_tract('alaskan') %>% mutate(race = 'alaskan')
  asian <- request_below_poverty_by_tract('asian') %>% mutate(race = 'asian')
  hawaian <- request_below_poverty_by_tract('hawaian') %>% mutate(race = 'hawaian')
  other <- request_below_poverty_by_tract('other') %>% mutate(race = 'other')
  multirace <- request_below_poverty_by_tract('multirace') %>% mutate(race = 'multirace')
  hispanic <- request_below_poverty_by_tract('hispanic') %>% mutate(race = 'hispanic')
  
  # combine all requests
  pov <- rbind(white, black, alaskan, asian, hawaian, other, multirace, hispanic)
  
  # extract Census tract from text
  pov <- pov %>% 
    mutate(
      tract = str_extract(NAME, '\\d+\\.*\\d*'),
      tract = case_when(
        str_length(tract) == 4 ~ paste0(tract, '.00'),
        str_length(tract) >4 & str_length(tract) <7 ~ str_pad(tract, 7, side='right', pad='0'),
        str_length(tract) ==7 ~ tract,
        TRUE ~ 'INVESTIGATE'),
      sex = case_when(
        grepl('female', variable) ~ 'Female',
        grepl('male', variable)   ~ 'Male',
        TRUE ~ 'Total'),
      agecat = case_when(
        grepl('25_34', variable)   ~ '25-34',
        grepl('35_44', variable)   ~ '35-44',
        grepl('45_54', variable)   ~ '45-54',
        grepl('55_64', variable)   ~ '55-64',
        grepl('65_74', variable)   ~ '65-74',
        grepl('75_pl', variable)   ~ '>=75',
        TRUE ~ 'Total')
      )
  
  
  pov <- pov %>% 
    # derive proportions and their MOEs
    left_join(pov %>% 
                # the denominators need to be adjusted to that they only consider
                #   the age categories of interest
                #   and because the ACS supplies them them by poverty-status 
                #   (we need to aggregate over status)
                filter(agecat != 'Total' & sex != 'Total') %>% 
                group_by(tract, sex, race) %>% 
                mutate(denom = sum(estimate, na.remove=TRUE)) %>% 
                distinct(tract, sex, race, denom)
              ) %>% 
    left_join(pov %>% 
                filter(agecat == 'Total' & sex != 'Total') %>% 
                distinct(tract, sex, race, moe) %>% 
                rename(moe_denom = moe)
              ) %>% 
    mutate(proportion = estimate/denom,
           proportion_moe = abs(sqrt((moe^2) - ((estimate/denom)^2 * moe_denom)))/denom,
           proportion_moe = ifelse(agecat=='Total', NA_real_, proportion_moe),
           # proportions for 'Total' fields will no longer == 1.0
           # ... reset that for sanity's sake
           proportion = ifelse(agecat == 'Total' & sex != 'Total', NA_real_, proportion),
           proportion_moe = ifelse(agecat == 'Total' & sex != 'Total', NA_real_, proportion_moe),
           denom = ifelse(agecat == 'Total' & sex != 'Total', NA_real_, denom),
           moe_denom = ifelse(agecat == 'Total' & sex != 'Total', NA_real_, moe_denom)
           ) %>% 
    # clean up
    rename(geoid=GEOID, name=NAME) %>%
    distinct(poverty_status, agecat, sex, race, tract, .keep_all=TRUE)
  
  return(pov)
  
}
```


```{r message=FALSE, warning=FALSE}

##################################################################
#                          Read in data 
#               or Make API calls and save output
##################################################################

dir.create(file.path('data'), showWarnings = FALSE)

ed_filepath  <- file.path('data', 'educational_attainment.csv')
age_national_filepath <- file.path('data', 'agecat_national.csv')
pov_filepath <- file.path('data', 'povertyt_status_12m.csv')

# READ tract as CHARACTER!!!

# Get educational attainment data
# -------------------------------
if(file.exists(ed_filepath)){
  ed <- vroom::vroom(ed_filepath,
                     col_types = cols(tract=col_character()))
} else{
  ed <- create_ed_by_tract_df()
  
  # write out
  readr::write_excel_csv(ed, ed_filepath)
}

# Get age (national) category data
# --------------------------------
if(file.exists(age_national_filepath)){
  age <- vroom::vroom(age_national_filepath)
} else {
  age <- create_age_df()
  
  # write out
  readr::write_excel_csv(age, age_national_filepath)
}


# Get poverty status data
# -----------------------
if(file.exists(pov_filepath)){
  pov <- vroom::vroom(pov_filepath,
                     col_types = cols(tract=col_character()))
} else {
  pov <- create_poverty_by_tract_df()
  
  # write out
  readr::write_excel_csv(pov, pov_filepath)
}

```


#### Example without breaking down by age-category {.tabset}
##### Absolute numbers
```{r message=FALSE, warning=FALSE}
dat <- ed %>% 
  filter(tract == 1115.67) %>% 
  filter(sex == 'Male') %>% 
  filter(race %in% c('white', 'black', 'hispanic')) %>% 
  filter(education != 'Total') %>% 
  ungroup()
  

dat$education <- factor(dat$education, 
                        levels=c('Less than high school', 
                                 'High school graduate', 
                                 'Some college', 
                                 'College graduate'))

# stacked bar chart
ggplot(dat,
       aes(fill=race, y=estimate, x=education, label=estimate)) + 
  geom_bar(position="stack", stat="identity") +
  geom_errorbar(aes(ymin = estimate - moe, 
                    ymax = estimate + moe), width = 0.2) +
  geom_text(size = 2.8,
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~race, ncol = 1) + 
  coord_flip() +
  labs(
    x = 'Highest Level of Education Achieved',
    y = 'Number of persons',
    title = 'Male -- Tract 1115.67',
    fill = 'Race/Ethnicity') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
        plot.title = element_text(hjust = 0.5))
```

<p></p>
##### Proportions
```{r message=FALSE, warning=FALSE}
# stacked bar chart
ggplot(dat,
       aes(fill=race, y=proportion, x=education, label=round(proportion, 2))) + 
  geom_bar(position="stack", stat="identity") +
  geom_errorbar(aes(ymin = proportion - proportion_moe, 
                    ymax = proportion + proportion_moe), width = 0.2) +
  geom_text(size = 2.8,
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~race, ncol = 1) + 
  coord_flip() +
  labs(
    x = 'Highest Level of Education Achieved',
    y = 'Proportion',
    title = 'Male -- Tract 1115.67',
    fill = 'Race/Ethnicity') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
        plot.title = element_text(hjust = 0.5))
```
<p class="Notes">
<strong>Notes</strong>
The 95% confidence limits were derived from the ACS handbook using the formula: 
$MOE_p = \frac{\pm \sqrt{MOE_{num}^{2} - [(\frac{X_{num}}{X_{den}}^2) * MOE_{den}^2]}}{X_{num}}$
</p>


<p></p>
#### Calculate the estimated probabilities
*First*, we snag the proportion of the population, in 2020 (in each Census tract, 
sex, and race) with each available category of "highest educational attainment".
  
*Then*, we snag the proportion of the population (within available age 
categories) with each available category of "highest educational attainment".
  
*Finally*, we obtain the estimated probability of education attainment level XXX 
by multiplying these probabilities (proportions).  


<p></p>
#### Examples {.tabset}
##### Males
What is the likelihood of educational attainment XXX for a "white" male residing 
in Census tract 1141.03 during 2020 (given their age at run-time)?  
```{r message=FALSE}

estimates <- ed %>% 
  filter(education != 'Total') %>% 
  select(education, sex, race, tract, estimate, moe, proportion, proportion_moe) %>% 
  left_join(age %>% select(education, agecat, proportion, proportion_moe) %>% 
              rename(p_age = proportion, p_age_moe = proportion_moe)) %>% 
  mutate(p = proportion*p_age,
         p_moe = abs(sqrt( (proportion^2 * p_age_moe^2) + (p_age^2 * proportion_moe^2) ))
  ) %>% 
  mutate(agecat = ifelse(agecat == '25-29', '25-34', agecat))

# example
dat <- estimates %>% 
  filter(tract == 1115.67) %>% 
  filter(sex == 'Male') %>% 
  filter(race %in% c('white', 'black', 'hispanic')) %>% 
  ungroup() %>% 
  select(tract, sex, race, agecat, education, p_age, p, p_moe)

#sum(z) == 1.0 ... sanity check!!

# pivot data for plotting
dat$agecat <- factor(dat$agecat,
                     levels=c('25-34', '35-44', '45-64', '>=65'))

dat$education <- factor(dat$education, 
                        levels=c('Less than high school', 
                                 'High school graduate', 
                                 'Some college', 
                                 'College graduate'))

# stacked bar chart
ggplot(dat,
       aes(fill=agecat, y=p, x=education, label=round(p, 2))) + 
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 2.8,
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~race, ncol = 1) + 
  coord_flip() +
  labs(
    x = 'Highest Level of Education Achieved',
    y = 'Proportion',
    title = 'Male -- Tract 1115.67',
    fill = 'Age Category') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
        plot.title = element_text(hjust = 0.5))
```
<p class="Notes">
<strong>Notes</strong>
Appropriate margins of error, standard errors, and confidence intervals can 
be derived as described in the ACS handbook.
</p>


<p></p>
##### Females
What about for a female?
```{r message=FALSE}

estimates <- ed %>% 
  filter(education != 'Total') %>% 
  select(education, sex, race, tract, estimate, moe, proportion, proportion_moe) %>% 
  left_join(age %>% select(education, agecat, proportion, proportion_moe) %>% 
              rename(p_age = proportion, p_age_moe = proportion_moe)) %>% 
  mutate(p = proportion*p_age,
         p_moe = abs(sqrt( (proportion^2 * p_age_moe^2) + (p_age^2 * proportion_moe^2) ))
  ) %>% 
  mutate(agecat = ifelse(agecat == '25-29', '25-34', agecat))

# example
dat <- estimates %>% 
  filter(tract == 1115.67) %>% 
  filter(sex == 'Female') %>% 
  filter(race %in% c('white', 'black', 'hispanic')) %>% 
  ungroup() %>% 
  select(tract, sex, race, agecat, education, p_age, p, p_moe)

#sum(z) == 1.0 ... sanity check!!

# pivot data for plotting
dat$agecat <- factor(dat$agecat,
                     levels=c('25-34', '35-44', '45-64', '>=65'))

dat$education <- factor(dat$education, 
                        levels=c('Less than high school', 
                                 'High school graduate', 
                                 'Some college', 
                                 'College graduate'))

# stacked bar chart
ggplot(dat,
       aes(fill=agecat, y=p, x=education, label=round(p, 2))) + 
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 2.8,
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~race, ncol = 1) + 
  coord_flip() +
  labs(
    x = 'Highest Level of Education Achieved',
    y = 'Proportion',
    title = 'Female -- Tract 1115.67',
    fill = 'Age Category') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
        plot.title = element_text(hjust = 0.5))
```
<p class="Notes">
<strong>Notes</strong>
Appropriate margins of error, standard errors, and confidence intervals can 
be derived as described in the ACS handbook.
</p>


<p></p>
##### Validation
As a sanity check, see the [Census Reporter](https://censusreporter.org/profiles/14000US48439114103-census-tract-114103-tarrant-tx/).


<p></p>
#### Example using poverty status in the past 12 months {.tabset}
The data for these plots derives entirely from tables 
[B17001*](https://data.census.gov/cedsci/table?q=B17001).  

##### Males
```{r message=FALSE, warning=FALSE}
dat <- pov %>% 
  filter(poverty_status != 'Total') %>% 
  # example data
  filter(tract == 1115.67) %>% 
  filter(sex == 'Male') %>% 
  filter(race %in% c('white', 'black', 'hispanic')) %>% 
  filter(agecat != 'Total') %>% 
  select(agecat, race, poverty_status, proportion, proportion_moe)


# stacked bar chart
ggplot(dat,
       aes(fill=agecat, y=proportion, x=poverty_status, label=round(proportion, 2))) + 
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 2.8,
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~race, ncol = 1) + 
  coord_flip() +
  labs(
    x = 'Poverty Status in the Past 12 Months',
    y = 'Proportion',
    title = 'Male -- Tract 1115.67',
    fill = 'Age Category') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
        plot.title = element_text(hjust = 0.5))
```
<p class="Notes">
<strong>Notes</strong>
Appropriate margins of error, standard errors, and confidence intervals can 
be derived as described in the ACS handbook (the MOEs calculated, thus far,
correctly account for the fact that ages < 25 years were left out ... but 
they do **not** correctly account the the aggregation of estimates over poverty
status).
</p>


<p></p>
##### Females
```{r message=FALSE, warning=FALSE}
dat <- pov %>% 
  filter(poverty_status != 'Total') %>% 
  # example data
  filter(tract == 1115.67) %>% 
  filter(sex == 'Female') %>% 
  filter(race %in% c('white', 'black', 'hispanic')) %>% 
  filter(agecat != 'Total') %>% 
  select(agecat, race, poverty_status, proportion, proportion_moe)


# stacked bar chart
ggplot(dat,
       aes(fill=agecat, y=proportion, x=poverty_status, label=round(proportion, 2))) + 
  geom_bar(position="stack", stat="identity") +
  geom_text(size = 2.8,
            position = position_stack(vjust = 0.5)) +
  facet_wrap(~race, ncol = 1) + 
  coord_flip() +
  labs(
    x = 'Poverty Status in the Past 12 Months',
    y = 'Proportion',
    title = 'Female -- Tract 1115.67',
    fill = 'Age Category') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
        plot.title = element_text(hjust = 0.5))
```
<p class="Notes">
<strong>Notes</strong>
Appropriate margins of error, standard errors, and confidence intervals can 
be derived as described in the ACS handbook (the MOEs calculated, thus far,
correctly account for the fact that ages < 25 years were left out ... but 
they do **not** correctly account the the aggregation of estimates over poverty
status).
</p>